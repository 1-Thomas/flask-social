{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
  <h1>Flask Social</h1>

  {% if current_user.is_authenticated %}
    <p><a href="{{ url_for('main.create_post') }}">Create post</a></p>
  {% else %}
    <p><a href="{{ url_for('auth.login') }}">Login</a> to post.</p>
  {% endif %}

  <hr>

  {% if posts %}
    {% for post in posts %}
      <div style="margin-bottom: 20px;">
        <strong>
          <a href="{{ url_for('main.profile', username=post.author.username) }}">
            {{ post.author.username }}
          </a>
        </strong>
        <small>· {{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>

        {% if current_user.is_authenticated and post.author.id == current_user.id %}
          <div style="margin-top: 6px;">
            <a href="{{ url_for('main.edit_post', post_id=post.id) }}">Edit</a>

            <form method="post"
                  action="{{ url_for('main.delete_post', post_id=post.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('Delete this post?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit">Delete</button>
            </form>
          </div>
        {% endif %}

        <div style="white-space: pre-wrap;">
          {{ post.body }}
        </div>

        <!-- Likes -->
        <div>
          <small>Likes: {{ post.like_count() }}</small>

          {% if current_user.is_authenticated %}
            {% if current_user.has_liked(post) %}
              <form method="post"
                    action="{{ url_for('main.unlike_post', post_id=post.id) }}"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Unlike</button>
              </form>
            {% else %}
              <form method="post"
                    action="{{ url_for('main.like_post', post_id=post.id) }}"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Like</button>
              </form>
            {% endif %}
          {% endif %}
        </div>

        <!-- Comments -->
        <div style="margin-top: 8px; padding-left: 12px; border-left: 2px solid #ddd;">
          <small><strong>Comments ({{ post.comments.count() }})</strong></small>

          {% for c in post.comments.order_by(Comment.created_at.asc()).all() %}
            <div style="margin-top: 6px;">
              <strong>
                <a href="{{ url_for('main.profile', username=c.author.username) }}">
                  {{ c.author.username }}
                </a>
              </strong>
              <small>· {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
              <div style="white-space: pre-wrap;">{{ c.body }}</div>
            </div>
          {% endfor %}

          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('main.add_comment', post_id=post.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <textarea name="body" rows="2" cols="50" maxlength="280" required></textarea>
              <button type="submit">Reply</button>
            </form>
          {% if pagination %}
            <div style="margin-top: 18px;">
              {% if pagination.has_prev %}
                <a href="{{ url_for(request.endpoint, **request.view_args, page=pagination.prev_num) }}">Previous</a>
              {% endif %}

              <span style="margin: 0 10px;">
                Page {{ pagination.page }} of {{ pagination.pages if pagination.pages > 0 else 1 }}
              </span>

              {% if pagination.has_next %}
                <a href="{{ url_for(request.endpoint, **request.view_args, page=pagination.next_num) }}">Next</a>
              {% endif %}
            </div>          
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No posts yet.</p>
  {% endif %}
{% endblock %}
