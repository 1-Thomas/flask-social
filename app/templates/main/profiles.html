{% extends "base.html" %}
{% block title %}{{ profile_user.username }}{% endblock %}
{% block content %}
  <h1>@{{ profile_user.username }}</h1>

  <p>{{ profile_user.bio or "No bio yet." }}</p>
  <p><small>Joined: {{ profile_user.created_at.strftime('%Y-%m-%d') }}</small></p>

  {% if current_user.is_authenticated and current_user.id == profile_user.id %}
    <p><a href="{{ url_for('main.edit_profile') }}">Edit profile</a></p>
  {% endif %}

  {% if current_user.is_authenticated and current_user.id != profile_user.id %}
    {% if current_user.is_following(profile_user) %}
      <form method="post" action="{{ url_for('main.unfollow', username=profile_user.username) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Unfollow</button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('main.follow', username=profile_user.username) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Follow</button>
      </form>
    {% endif %}
  {% endif %}

  <hr>
  <h2>Posts</h2>

  {% if posts %}
    {% for post in posts %}
      <div style="margin-bottom: 20px;">
        <small>{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>

        {% if current_user.is_authenticated and post.author.id == current_user.id %}
          <div style="margin-top: 6px;">
            <a href="{{ url_for('main.edit_post', post_id=post.id) }}">Edit</a>

            <form method="post"
                  action="{{ url_for('main.delete_post', post_id=post.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('Delete this post?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit">Delete</button>
            </form>
          </div>
        {% endif %}

        <div style="white-space: pre-wrap;">
          {{ post.body }}
        </div>

        <!-- Likes -->
        <div>
          <small>Likes: {{ post.like_count() }}</small>

          {% if current_user.is_authenticated %}
            {% if current_user.has_liked(post) %}
              <form method="post"
                    action="{{ url_for('main.unlike_post', post_id=post.id) }}"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Unlike</button>
              </form>
            {% else %}
              <form method="post"
                    action="{{ url_for('main.like_post', post_id=post.id) }}"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Like</button>
              </form>
            {% endif %}
          {% endif %}
        </div>

        <!-- Comments -->
        <div style="margin-top: 8px; padding-left: 12px; border-left: 2px solid #ddd;">
          <small><strong>Comments ({{ post.comments.count() }})</strong></small>

          {% for c in post.comments.order_by(Comment.created_at.asc()).all() %}
            <div style="margin-top: 6px;">
              <strong>
                <a href="{{ url_for('main.profile', username=c.author.username) }}">
                  {{ c.author.username }}
                </a>
              </strong>
              <small>Â· {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
              <div style="white-space: pre-wrap;">{{ c.body }}</div>
            </div>
          {% endfor %}

          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('main.add_comment', post_id=post.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <textarea name="body" rows="2" cols="50" maxlength="280" required></textarea>
              <button type="submit">Reply</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No posts yet.</p>
  {% endif %}
{% endblock %}
